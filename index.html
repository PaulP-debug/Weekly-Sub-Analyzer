import streamlit as st
import pandas as pd
from io import StringIO

# -----------------------------------------------------------
# PAGE SETTINGS
# -----------------------------------------------------------
st.set_page_config(page_title="Weekly Subscription Analyzer", layout="wide")

st.title("üìä Weekly Subscription Analyzer")
st.write("Paste your tables below. Make sure the headers are included exactly as required.")

# -----------------------------------------------------------
# EXPECTED HEADERS
# -----------------------------------------------------------
EXPECTED_BOX1_HEADERS = [
    "Status",
    "Updated",
    "App Order Id",
    "Order No",
    "Channel",
    "Purchase ID",
    "Purchase Type",
    "Amount"
]

EXPECTED_BOX2_HEADERS = [
    "Played SC",
    "Unplayed SC",
    "GC",
    "Current Played SC",
    "Current Unplayed SC",
    "Current Chips",
    "Reason",
    "Note1",
    "Note2",
    "Creating Time"
]


# -----------------------------------------------------------
# HELPER FUNCTIONS
# -----------------------------------------------------------
def parse_table(text):
    """Convert pasted CSV text to a DataFrame."""
    return pd.read_csv(StringIO(text))


def validate_headers(df, expected):
    """Check if DataFrame headers match expected headers exactly."""
    return list(df.columns) == expected


# -----------------------------------------------------------
# BOX 1
# -----------------------------------------------------------
st.subheader("üì• Box 1 ‚Äî Subscription Payment Data (8 Columns)")
st.caption("Headers must be EXACTLY: " + ", ".join(EXPECTED_BOX1_HEADERS))

box1_text = st.text_area("Paste Box 1 Data Here", height=200)

df1 = None
if box1_text.strip():
    try:
        df1 = parse_table(box1_text)
        st.success("Box 1 loaded successfully!")

        if not validate_headers(df1, EXPECTED_BOX1_HEADERS):
            st.error("‚ùå Column mismatch. Expected headers:\n" + ", ".join(EXPECTED_BOX1_HEADERS))
        else:
            st.dataframe(df1, use_container_width=True)

    except Exception as e:
        st.error(f"‚ùå Failed to parse Box 1 data: {e}")


# -----------------------------------------------------------
# BOX 2
# -----------------------------------------------------------
st.subheader("üì• Box 2 ‚Äî Chips / SC Data (10 Columns)")
st.caption("Headers must be EXACTLY: " + ", ".join(EXPECTED_BOX2_HEADERS))

box2_text = st.text_area("Paste Box 2 Data Here", height=200)

df2 = None
if box2_text.strip():
    try:
        df2 = parse_table(box2_text)
        st.success("Box 2 loaded successfully!")

        if not validate_headers(df2, EXPECTED_BOX2_HEADERS):
            st.error("‚ùå Column mismatch. Expected headers:\n" + ", ".join(EXPECTED_BOX2_HEADERS))
        else:
            st.dataframe(df2, use_container_width=True)

    except Exception as e:
        st.error(f"‚ùå Failed to parse Box 2 data: {e}")


# -----------------------------------------------------------
# READY FOR ANALYSIS INDICATOR
# -----------------------------------------------------------
if df1 is not None and df2 is not None:
    st.markdown("---")
    st.subheader("‚ú® Ready for Analysis")
    st.write("Both tables are loaded successfully. Tell me what analysis you want to add next!")
