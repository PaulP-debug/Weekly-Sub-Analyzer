<script>
// Parse timestamp and apply 08:00 cutoff
function parseTS(x){
  x = x.trim();
  if(!x) return null; // skip empty lines
  let d = new Date(x.replace(/\s+/, 'T'));
  if(isNaN(d.getTime())) return null; // invalid date
  if(d.getHours() < 8){
    d.setDate(d.getDate() - 1);  // move to previous day
  }
  return d;
}

// Format date in 24-hour format
function formatDate24(d){
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const dd = String(d.getDate()).padStart(2,'0');
  const hh = String(d.getHours()).padStart(2,'0');
  const min = String(d.getMinutes()).padStart(2,'0');
  const ss = String(d.getSeconds()).padStart(2,'0');
  return `${yyyy}-${mm}-${dd} ${hh}:${min}:${ss}`;
}

function analyze(){
 const b1 = document.getElementById('box1').value.trim().split(/\n/).filter(l=>l.trim()!=='');
 const b2 = document.getElementById('box2').value.trim().split(/\n/).filter(l=>l.trim()!=='');
 let subs=[];

 // Purchases (4 lines each)
 for(let i=0;i<b1.length;i+=4){
   if(i+3 >= b1.length) continue; // skip incomplete entry
   let updated = b1[i].trim();
   let ptype = b1[i+2].trim();
   let amt = parseFloat(b1[i+3]);
   if(ptype !== 'sub_pack') continue;
   let tier = amt===7 ? 'Bronze' : amt===30 ? 'Silver' : amt===90 ? 'Gold' : null;
   if(!tier) continue;
   let start = parseTS(updated);
   if(!start) continue;
   let end = new Date(start.getTime() + 7*24*3600*1000); // 7-day subscription
   subs.push({tier,start,end});
 }

 // Claims (3 lines each)
 let claims=[];
 for(let i=0;i<b2.length;i+=3){
   if(i+2 >= b2.length) continue; // skip incomplete entry
   let unplayed = parseFloat(b2[i]);
   let gc = parseFloat(b2[i+1]);
   let ts = b2[i+2].trim();
   let tier = null;
   if(unplayed===0.5 && gc===2000) tier='Bronze';
   if(unplayed===2 && gc===10000) tier='Silver';
   if(unplayed===5.5 && gc===40000) tier='Gold';
   if(!tier) continue;
   let claimDate = parseTS(ts);
   if(!claimDate) continue;
   claims.push({tier, ts: claimDate});
 }

 let html='';
 subs.forEach((s,idx)=>{
   const color = s.tier==='Bronze'?'bronze':s.tier==='Silver'?'silver':'gold';
   html += `<h3 class="${color}">${s.tier} Subscription (${formatDate24(s.start)} â†’ ${formatDate24(s.end)})</h3>`;
   let days=[];
   for(let d=0; d<7; d++){
     let dayStart = new Date(s.start.getTime() + d*86400000);
     let dayEnd = new Date(dayStart.getTime() + 86400000);
     let claim = claims.find(c=>c.tier===s.tier && c.ts>=dayStart && c.ts<dayEnd);
     let today = new Date();
     let cls = claim? 'claimed': (dayEnd>today? 'future':'missed');
     days.push(`<div class="day ${cls}"><b>Day ${d+1}</b><br>${formatDate24(dayStart)}${claim? '<br>Claimed':''}${cls==='future'?'<br>Future':''}${cls==='missed'?'<br>Not Claimed':''}</div>`);
   }
   html += `<div class="grid">${days.join('')}</div>`;
 });

 document.getElementById('results').innerHTML = html;
}
</script>
