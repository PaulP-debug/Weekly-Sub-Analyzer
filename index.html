<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Weekly Subscription Analyzer</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; background:#f5f7fb; }
  h1,h2,h3 { margin-top: 20px; }
  textarea { width: 100%; height: 180px; font-family: monospace; margin-top: 6px; }
  button { padding: 10px 20px; margin-top: 12px; font-size: 16px; cursor: pointer; }
  table { border-collapse: collapse; width: 100%; margin-top: 10px; }
  th, td { border: 1px solid #ccc; padding: 6px; font-size: 14px; }
  .bronze { background: #cd7f32; color: white; padding:4px; border-radius:4px; }
  .silver { background: #c0c0c0; color: black; padding:4px; border-radius:4px; }
  .gold { background: #ffd700; color: black; padding:4px; border-radius:4px; }
  .grid { display: grid; grid-template-columns: repeat(7, 1fr); margin-top: 10px; gap: 4px; }
  .day { border: 1px solid #ccc; padding: 4px; height: 70px; font-size: 12px; border-radius:4px; }
  .claimed { background: #c6efce; }
  .missed { background: #ffc7ce; }
  .future { background: #fff2cc; }
</style>
</head>
<body>

<h1>Weekly Subscription Analyzer</h1>

<h2>Purchases Data</h2>
<textarea id="purchasesBox" placeholder="Paste stacked Purchases Data here..."></textarea>

<h2>Game Flow Data</h2>
<textarea id="flowBox" placeholder="Paste stacked Game Flow Data here..."></textarea>

<button onclick="analyze()">Analyze Subscriptions</button>

<h2>Results</h2>
<div id="results"></div>

<script>
function parseDateFlexible(s){
  if(!s) return null;
  let t = s.trim();
  if(/^\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2}/.test(t)) t = t.replace(/\s+/, 'T');
  const d = new Date(t);
  return isNaN(d)? null : d;
}

function analyze(){
  const rawPurchases = document.getElementById('purchasesBox').value.trim().split(/\n/);
  const rawFlow = document.getElementById('flowBox').value.trim().split(/\n/);

  // --- Stitch Purchases (4-line blocks) ---
  let purchases = [];
  for(let i=0;i<rawPurchases.length;){
    if(rawPurchases[i].toLowerCase().includes('status')) { i++; continue; } // skip header lines
    const status = rawPurchases[i++]?.trim() || '';
    const lineB  = rawPurchases[i++]?.trim() || '';
    const ptype  = rawPurchases[i++]?.trim() || '';
    const amount = rawPurchases[i++]?.trim() || '';

    if(status.toLowerCase() !== 'succeed') continue;
    if(ptype.toLowerCase() !== 'sub_pack') continue;
    const parts = lineB.split(/\t+/);
    const updated = parseDateFlexible(parts[0]);
    if(!updated) continue;

    let tier=null;
    const amtNum=parseFloat(amount);
    if(amtNum===7) tier='Bronze';
    else if(amtNum===30) tier='Silver';
    else if(amtNum===90) tier='Gold';
    if(!tier) continue;

    purchases.push({tier, start: updated, end: new Date(updated.getTime()+7*24*3600*1000)});
  }

  // --- Stitch Game Flow (3-line blocks) ---
  let claims = [];
  for(let i=0;i<rawFlow.length;){
    if(rawFlow[i].toLowerCase().includes('played')) { i++; continue; } // skip header
    const line1 = rawFlow[i++]?.trim() || '';
    const line2 = rawFlow[i++]?.trim() || '';
    const line3 = rawFlow[i++]?.trim() || '';

    const parts1 = line1.split(/\t+/);
    const parts3 = line3.split(/\t+/);
    if(parts1.length < 6) continue;
    const unplayed=parseFloat(parts1[1]);
    const gc=parseFloat(parts1[2]);
    const ts=parseDateFlexible(parts3[parts3.length-1]);
    if(!ts) continue;

    let tier=null;
    if(Math.abs(unplayed-0.5)<0.01 && Math.abs(gc-2000)<1) tier='Bronze';
    else if(Math.abs(unplayed-2.0)<0.01 && Math.abs(gc-10000)<1) tier='Silver';
    else if(Math.abs(unplayed-5.5)<0.01 && Math.abs(gc-40000)<1) tier='Gold';
    if(!tier) continue;
    claims.push({tier, ts});
  }

  // --- Render results ---
  const now = new Date();
  let html='';
  purchases.forEach((sub, idx)=>{
    const color=sub.tier==='Bronze'?'bronze':sub.tier==='Silver'?'silver':'gold';
    html += `<h3 class="${color}">${sub.tier} Subscription (${sub.start.toLocaleString()} â†’ ${sub.end.toLocaleString()})</h3>`;
    let days=[];
    for(let d=0; d<7; d++){
      const dayStart = new Date(sub.start.getTime() + d*86400000);
      const dayEnd = new Date(dayStart.getTime() + 86400000);
      const claim = claims.find(c=>c.tier===sub.tier && c.ts>=dayStart && c.ts<dayEnd);
      let cls = claim?'claimed':(dayEnd>now?'future':'missed');
      days.push(`<div class="day ${cls}"><b>Day ${d+1}</b><br>${dayStart.toLocaleDateString()}${claim?'<br>Claimed':''}${cls==='future'?'<br>Future':''}${cls==='missed'?'<br>Not Claimed':''}</div>`);
    }
    html += `<div class="grid">${days.join('')}</div>`;
  });

  document.getElementById('results').innerHTML = html;
}
</script>

<p style="margin-top:40px; font-size:12px;">Signature by: Paul P</p>
</body>
</html>
