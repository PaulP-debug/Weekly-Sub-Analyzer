<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Weekly Subscription Analyzer</title>
<style>
 body { font-family: Arial, sans-serif; padding: 20px; }
 h2 { margin-top: 30px; }
 textarea { width: 100%; height: 180px; font-family: monospace; }
 table { border-collapse: collapse; width: 100%; margin-top: 10px; }
 th, td { border: 1px solid #ccc; padding: 6px; font-size: 14px; }
 .bronze { background: #cd7f32; color: white; }
 .silver { background: #c0c0c0; color: black; }
 .gold { background: #ffd700; color: black; }
 .grid { display: grid; grid-template-columns: repeat(7, 1fr); margin-top: 10px; }
 .day { border: 1px solid #ccc; padding: 4px; height: 70px; font-size: 12px; }
 .claimed { background: #c6efce; }
 .missed { background: #ffc7ce; }
 .future { background: #d9d9d9; }
 .extended { background: #ffeb9c; }
 .extended-week { margin-top:10px; padding:4px; background: #fff2cc; border:1px solid #ccc; }
</style>
</head>
<body>
<h1>Weekly Subscription Analyzer</h1>

<h2>Purchases Data</h2>
<textarea id="box1" placeholder="Paste Purchases Data here..."></textarea>

<h2>Game Flow Data</h2>
<textarea id="box2" placeholder="Paste Game Flow Data here..."></textarea>

<button onclick="analyze()" style="padding:10px 25px; margin-top:20px; font-size:16px;">Analyze Subscription</button>

<h2>Results</h2>
<div id="results"></div>

<script>
function parseTS(x){
    let dt = new Date(x.replace(/\s+/,'T'));
    return dt;
}

function dayReset(dt){
    let d = new Date(dt);
    if(d.getHours()<8){
        d.setDate(d.getDate()-1);
    }
    d.setHours(8,0,0,0);
    return d;
}

function format24(dt){
    let y = dt.getFullYear();
    let m = String(dt.getMonth()+1).padStart(2,'0');
    let d = String(dt.getDate()).padStart(2,'0');
    let h = String(dt.getHours()).padStart(2,'0');
    let mi = String(dt.getMinutes()).padStart(2,'0');
    let s = String(dt.getSeconds()).padStart(2,'0');
    return `${y}-${m}-${d} ${h}:${mi}:${s}`;
}

function analyze(){
    const b1 = document.getElementById('box1').value.trim().split(/\n/);
    const b2 = document.getElementById('box2').value.trim().split(/\n/);

    // Parse purchases (4 lines)
    let subs=[];
    for(let i=0;i<b1.length;i+=4){
        let status = b1[i].trim();
        if(status!=='Succeed') continue;
        let updated = b1[i+1].split('\t')[0].trim();
        let ptype = b1[i+2].trim();
        let amt = parseFloat(b1[i+3].trim());
        let tier = amt===7? 'Bronze': amt===30? 'Silver': amt===90? 'Gold': null;
        if(ptype==='sub_pack') tier='Bronze';
        if(!tier) continue;
        let start = parseTS(updated);
        subs.push({tier,start,originalStart:start, extended:false});
    }

    // Sort and merge for extensions
    subs.sort((a,b)=>a.start-b.start);
    let mergedSubs = [];
    subs.forEach(s=>{
        let last = mergedSubs.filter(ms=>ms.tier===s.tier).slice(-1)[0];
        if(last && s.start <= last.end){
            // Add as extended subscription
            mergedSubs.push({...s, extended:true, end:new Date(s.start.getTime()+7*24*3600*1000)});
        } else {
            s.end = new Date(s.start.getTime()+7*24*3600*1000);
            mergedSubs.push(s);
        }
    });

    // Parse claims (3 lines)
    let claims=[];
    for(let i=0;i<b2.length;i+=3){
        let tierLine = b2[i+1].trim();
        let tier = tierLine.includes('Bronze')?'Bronze':tierLine.includes('Silver')?'Silver':'Gold';
        let ts = parseTS(b2[i+2].trim());
        claims.push({tier, ts});
    }

    // Generate output
    let html='';
    mergedSubs.forEach((s,idx)=>{
        const color = s.tier==='Bronze'?'bronze':s.tier==='Silver'?'silver':'gold';
        html += `<h3 class="${color}">${s.tier} Subscription (${format24(s.start)} â†’ ${format24(s.end)})${s.extended? ' (Extended)':''}</h3>`;

        let weekStart = new Date(s.start);
        let totalDays = Math.ceil((s.end - s.start)/(24*3600*1000));
        let weekCount = Math.ceil(totalDays/7);

        for(let w=0; w<weekCount; w++){
            let weekDiv = `<div class="grid ${s.extended && w>0? 'extended-week':''}">`;
            for(let d=0; d<7; d++){
                let dayStart = new Date(weekStart.getTime() + (w*7 + d)*24*3600*1000);
                if(dayStart>=s.end) break;

                let dayResetStart = dayReset(dayStart);
                let dayEnd = new Date(dayStart.getTime()+24*3600*1000);
                if(dayEnd>s.end) dayEnd=s.end;

                let claim = claims.find(c=>c.tier===s.tier && c.ts>=dayResetStart && c.ts<dayEnd);
                let cls = claim? 'claimed': (dayEnd>new Date()? 'future':'missed');
                if(s.extended && w>0) cls='extended';

                weekDiv += `<div class="day ${cls}"><b>Day ${w*7+d+1}</b><br>${format24(dayStart)}${claim? '<br>Claimed':''}${cls==='future'?'<br>Future':''}${cls==='missed'?'<br>Not Claimed':''}${cls==='extended'?'<br>Extended':''}</div>`;
            }
            weekDiv += `</div>`;
            html += weekDiv;
        }
    });

    document.getElementById('results').innerHTML = html;
}
</script>
<p style="margin-top:40px; font-size:12px;">Signature by: Paul P</p>
</body>
</html>
