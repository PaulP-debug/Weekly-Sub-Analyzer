<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Weekly Subscription Analyzer</title>
<style>
 body { font-family: Arial, sans-serif; padding: 20px; }
 h2 { margin-top: 30px; }
 textarea { width: 100%; height: 180px; font-family: monospace; }
 table { border-collapse: collapse; width: 100%; margin-top: 10px; }
 th, td { border: 1px solid #ccc; padding: 6px; font-size: 14px; }
 .bronze { background: #cd7f32; color: white; }
 .silver { background: #c0c0c0; color: black; }
 .gold { background: #ffd700; color: black; }
 .grid { display: grid; grid-template-columns: repeat(7, 1fr); margin-top: 10px; }
 .day { border: 1px solid #ccc; padding: 4px; height: 70px; font-size: 12px; }
 .claimed { background: #c6efce; }
 .missed { background: #ffc7ce; }
 .future { background: #d9d9d9; }
 .extended { border: 2px dashed red; padding:2px; margin-bottom:10px;}
</style>
</head>
<body>
<h1>Weekly Subscription Analyzer</h1>

<h2>Purchases Data</h2>
<textarea id="box1" placeholder="Paste Purchases Data here..."></textarea>

<h2>Game Flow Data</h2>
<textarea id="box2" placeholder="Paste Game Flow Data here..."></textarea>

<button onclick="analyze()" style="padding:10px 25px; margin-top:20px; font-size:16px;">Analyze Subscription</button>

<h2>Results</h2>
<div id="results"></div>

<script>
function parseTS(x){ return new Date(x.replace(/\s+/,'T')); }

function adjustForReset(date){
  let d = new Date(date);
  if(d.getHours() < 8){
    d.setDate(d.getDate() -1);
  }
  d.setHours(d.getHours(), d.getMinutes(), d.getSeconds());
  return d;
}

function formatTS(date){
  const y = date.getFullYear();
  const m = ('0'+(date.getMonth()+1)).slice(-2);
  const d = ('0'+date.getDate()).slice(-2);
  const h = ('0'+date.getHours()).slice(-2);
  const min = ('0'+date.getMinutes()).slice(-2);
  const s = ('0'+date.getSeconds()).slice(-2);
  return `${y}-${m}-${d} ${h}:${min}:${s}`;
}

function analyze(){
 const b1 = document.getElementById('box1').value.trim().split(/\n/);
 const b2 = document.getElementById('box2').value.trim().split(/\n/);

 // Parse Purchases (4 lines each)
 let subs=[];
 for(let i=0;i<b1.length;i+=4){
   const status = b1[i].trim();
   if(status!=='Succeed') continue;
   const updated = parseTS(b1[i+1].split('\t')[0]);
   const ptype = b1[i+2].trim();
   const amt = parseFloat(b1[i+3]);
   let tier = amt===7? 'Bronze': amt===30? 'Silver': amt===90? 'Gold': null;
   if(ptype==='sub_pack') tier='Bronze';
   if(!tier) continue;

   // Adjust for 08:00 reset
   const start = updated;
   const adjustedStart = adjustForReset(start);

   // Check if overlapping previous subscription of same tier
   let prev = subs.filter(s=>s.tier===tier && adjustedStart <= s.end);
   if(prev.length){
     const lastSub = prev[prev.length-1];
     const newEnd = new Date(lastSub.end.getTime() + 7*24*3600*1000);
     subs.push({tier, start: adjustedStart, end: newEnd, extended:true, originalStart:start});
   } else {
     const end = new Date(adjustedStart.getTime() + 7*24*3600*1000);
     subs.push({tier, start: adjustedStart, end:end, extended:false, originalStart:start});
   }
 }

 // Parse Game Flow Data (3 lines per claim)
 let claims=[];
 for(let i=0;i<b2.length;i+=3){
   const tierLine = b2[i+1].trim();
   let tier=null;
   if(tierLine.includes('Bronze')) tier='Bronze';
   else if(tierLine.includes('Silver')) tier='Silver';
   else if(tierLine.includes('Gold')) tier='Gold';
   else if(tierLine.includes('Weekly Subscription')) tier='Bronze'; // default mapping

   const ts = parseTS(b2[i+2].split('\t')[2]);
   claims.push({tier, ts});
 }

 // Render results
 let html='';
 subs.forEach((s,idx)=>{
   const color = s.tier==='Bronze'?'bronze':s.tier==='Silver'?'silver':'gold';
   html += `<h3 class="${color}">${s.tier} Subscription (${formatTS(s.originalStart)} â†’ ${formatTS(s.end)})${s.extended? ' - Extended':''}</h3>`;
   if(s.extended) html += `<div class="extended">This subscription was extended</div>`;

   // Calculate days
   let days=[];
   let dayStart = new Date(s.originalStart);
   let dayCount=1;
   while(dayStart < s.end){
     let nextDay = new Date(dayStart);
     nextDay.setDate(nextDay.getDate()+1);
     nextDay.setHours(8,0,0,0);
     if(nextDay > s.end) nextDay = s.end;

     const claim = claims.find(c=>c.tier===s.tier && c.ts >= dayStart && c.ts < nextDay);
     const today = new Date();
     let cls = claim? 'claimed': (nextDay>today? 'future':'missed');

     days.push(`<div class="day ${cls}"><b>Day ${dayCount}</b><br>${formatTS(dayStart)}${claim? '<br>Claimed':''}${cls==='future'?'<br>Future':''}${cls==='missed'?'<br>Not Claimed':''}</div>`);
     dayStart = nextDay;
     dayCount++;
   }
   html += `<div class="grid">${days.join('')}</div>`;
 });

 document.getElementById('results').innerHTML = html;
}
</script>
<p style="margin-top:40px; font-size:12px;">Signature by: Paul P</p>
</body>
</html>
