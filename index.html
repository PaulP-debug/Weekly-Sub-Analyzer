<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Weekly Subscription Analyzer</title>
<style>
  /* ---------- Layout & typography ---------- */
  html,body { height:100%; margin:0; font-family: Arial, Helvetica, sans-serif; background:#f5f6fa; color:#222; }
  .container { max-width:1080px; margin:28px auto; padding:22px; background:#fff; border-radius:10px; box-shadow:0 6px 30px rgba(0,0,0,0.06); }
  h1 { margin:0 0 6px 0; font-size:22px; }
  p.lead { margin:6px 0 18px 0; color:#555; }
  label { font-weight:600; display:block; margin-top:12px; }
  textarea { width:100%; min-height:140px; padding:10px; border-radius:6px; border:1px solid #ddd; box-sizing:border-box; font-family:monospace; }
  .two { display:flex; gap:16px; margin-top:12px; }
  .col { flex:1; }
  .actions { display:flex; gap:8px; margin-top:12px; flex-wrap:wrap; align-items:center; }
  button { margin-top:6px; padding:10px 14px; border-radius:6px; border:none; cursor:pointer; font-weight:600; }
  .btn-analyze { background:#0f62fe; color:white; }
  .btn-summary { background:#8A2BE2; color:white; }
  .btn-clear { background:#efefef; color:#222; }
  .note { font-size:13px; color:#666; margin-top:8px; }
  .muted { color:#666; font-size:13px; }
  .small { font-size:13px; color:#444; }
  .sig { text-align:right; font-style:italic; opacity:0.7; margin-top:18px; }

  /* ---------- badges & colors ---------- */
  .badge { display:inline-block; padding:6px 10px; border-radius:12px; font-size:13px; color:#fff; margin-right:8px; font-weight:700; }
  .badge.bronze { background:#b87333; } /* bronze */
  .badge.silver { background:#9ea7b4; color:#111; } /* silver */
  .badge.gold   { background:#d4af37; color:#111; } /* gold */

  /* ---------- table & sections ---------- */
  .type-section { margin-top:18px; border-radius:8px; padding:12px; border:1px solid #eee; background:#fff; }
  .type-header { display:flex; align-items:center; justify-content:space-between; gap:12px; }
  .type-title { display:flex; align-items:center; gap:12px; }
  .table-scroll { max-height:420px; overflow:auto; margin-top:8px; border-radius:6px; }
  table { width:100%; border-collapse:collapse; margin-top:12px; }
  th, td { padding:8px 10px; border:1px solid #e6e6e6; text-align:left; font-size:13px; vertical-align:top; }
  th { background:#f8f9fc; }

  /* ---------- day states ---------- */
  .cal-container { margin-top:10px; }
  .calendar-grid { display:flex; gap:6px; margin-top:6px; }
  .cal-day { flex:1; text-align:center; padding:10px 6px; border-radius:6px; font-size:12px; font-weight:700; color:#222; border:1px solid #ddd; min-width:82px; }
  .cal-header { font-size:11px; color:#555; margin-bottom:3px; font-weight:600; }
  .cal-claimed { background:#d8f4dc; border-color:#8fdda2; } /* green */
  .cal-missed  { background:#ffe2e2; border-color:#ff9a9a; } /* red */
  .cal-future  { background:#fff6cc; border-color:#ffe680; } /* yellow */

  /* ---------- details (collapsed by default) with smooth animation ---------- */
  .details-wrap { overflow:hidden; transition: max-height 350ms ease, opacity 250ms ease; max-height: 0; opacity: 0; }
  .details-wrap.open { max-height: 2000px; opacity: 1; } /* large max-height to allow content */
  .details-body { padding:12px 8px; background:#fafafa; border-radius:6px; margin-top:8px; border:1px solid #eee; }
  .day-row { padding:8px; border-radius:6px; margin-bottom:8px; display:flex; gap:12px; align-items:flex-start; }
  .day-label { min-width:120px; font-weight:700; }
  .claim-times { font-size:13px; color:#111; }
  .status-claimed { color:#0b8a3e; font-weight:700; }
  .status-missed  { color:#b32a2a; font-weight:700; }
  .status-future  { color:#b07a00; font-weight:700; }

  /* ---------- small utilities ---------- */
  .inline-btn { padding:8px 10px; border-radius:6px; background:#0f62fe; color:#fff; border:none; cursor:pointer; font-weight:700; font-size:13px; }
  .nowrap { white-space:nowrap; }
  .small-muted { font-size:12px; color:#777; }
  pre { background:#fff; padding:8px; border-radius:6px; overflow:auto; max-height:180px; }

  @media (max-width:820px){
    .two { flex-direction:column; }
    .calendar-grid { gap:4px; }
    .cal-day { min-width:60px; font-size:11px; padding:8px 6px; }
  }
</style>
</head>
<body>
  <div class="container">
    <h1>Weekly Subscription Analyzer</h1>
    <p class="lead">Paste Box 1 (purchases) and Box 2 (claims). Click <strong>Analyze</strong> to compute subscription intervals and claim results. Each interval shows a color-coded 7-day calendar and a collapsed "Show Details" panel (smooth slide-down).</p>

    <div class="two">
      <div class="col">
        <label>Box 1 — Subscription Purchases (CSV with headers)</label>
        <textarea id="box1" placeholder="Status,Updated,App Order Id,Order No,Channel,Purchase ID,Purchase Type,Amount
Succeed,2025-11-01 07:45:00,abc,123,store,PID001,sub_pack,7.00
Succeed,2025-11-05 09:00:00,abc,124,store,PID002,sub_pack,7.00"></textarea>
        <div class="note">We only use: <strong>Status</strong>, <strong>Updated</strong>, <strong>Purchase Type</strong>, <strong>Amount</strong>. Only <code>sub_pack</code> with <code>Succeed</code> are considered.</div>
      </div>

      <div class="col">
        <label>Box 2 — Claims (CSV with headers)</label>
        <textarea id="box2" placeholder="Played SC,Unplayed SC,GC,Current Played SC,Current Unplayed SC,Current Chips,Reason,Note1,Note2,Creating Time
...,0.50,2000,...,2025-11-02 07:50:00"></textarea>
        <div class="note">We use: <strong>Unplayed SC</strong>, <strong>GC</strong>, <strong>Creating Time</strong>. These determine claim type and time.</div>
      </div>
    </div>

    <div class="actions">
      <button class="btn-analyze" onclick="analyzeAll()">Analyze</button>
      <button class="btn-summary" onclick="summaryOnly()">Summary</button>
      <button class="btn-clear" onclick="clearAll()">Clear</button>
      <div style="margin-left:8px;" class="small-muted">Headers are case-insensitive. Future days are shown as "To be Claimed".</div>
    </div>

    <div id="results" style="margin-top:18px;"></div>

    <p class="sig">— by: Paul P</p>
  </div>

<script>
/* -------------------------
   CSV parse & date helpers
   ------------------------- */
function parseCSV(text) {
  const lines = text.replace(/\r/g,'').split('\n').filter(l => l.trim().length > 0);
  if(lines.length === 0) return { headers: [], rows: [] };
  function splitLine(line) {
    const out = []; let cur = ''; let inQuotes = false;
    for(let i=0;i<line.length;i++){
      const ch = line[i];
      if(ch === '"') {
        if(inQuotes && i+1<line.length && line[i+1] === '"') { cur += '"'; i++; continue; }
        inQuotes = !inQuotes; continue;
      }
      if(ch === ',' && !inQuotes) { out.push(cur); cur = ''; } else cur += ch;
    }
    out.push(cur);
    return out.map(s => s.trim());
  }
  const headers = splitLine(lines[0]).map(h => h.trim());
  const rows = [];
  for(let i=1;i<lines.length;i++){
    const cols = splitLine(lines[i]);
    while(cols.length < headers.length) cols.push('');
    const obj = {};
    for(let j=0;j<headers.length;j++) obj[headers[j]] = cols[j] === undefined ? '' : cols[j];
    rows.push(obj);
  }
  return { headers, rows };
}

function parseDateFlexible(s){
  if(!s) return null;
  let t = String(s).trim();
  if(/^\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2}/.test(t)) t = t.replace(/\s+/, 'T');
  if(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}$/.test(t)) t = t + ':00';
  const d = new Date(t);
  if(!isNaN(d)) return d;
  const p = Date.parse(t);
  if(!isNaN(p)) return new Date(p);
  return null;
}

function fmt(dt){
  if(!dt) return '-';
  const yyyy = dt.getFullYear();
  const mm = String(dt.getMonth()+1).padStart(2,'0');
  const dd = String(dt.getDate()).padStart(2,'0');
  const hh = String(dt.getHours()).padStart(2,'0');
  const mi = String(dt.getMinutes()).padStart(2,'0');
  const ss = String(dt.getSeconds()).padStart(2,'0');
  return `${yyyy}-${mm}-${dd} ${hh}:${mi}:${ss}`;
}

function stripNumber(s){
  if(s === null || s === undefined) return NaN;
  const cleaned = String(s).replace(/[^\d.\-]/g, '');
  return parseFloat(cleaned);
}

/* -------------------------
   Business logic
   ------------------------- */
function isSuccess(status){
  if(status === null || status === undefined) return false;
  return String(status).trim().toLowerCase() === 'succeed';
}

function amountToType(amount){
  const n = Number(stripNumber(amount));
  if(isNaN(n)) return null;
  const key = Math.round(n * 100) / 100;
  if(key === 7) return 'Bronze';
  if(key === 30) return 'Silver';
  if(key === 90) return 'Gold';
  return null;
}

function detectClaimType(unplayedSC, gc){
  const a = Number(stripNumber(unplayedSC));
  const g = Number(stripNumber(gc));
  if(!isNaN(a) && !isNaN(g)){
    if(Math.abs(a - 0.5) < 0.001 && Math.abs(g - 2000) < 1) return 'Bronze';
    if(Math.abs(a - 2.0) < 0.001 && Math.abs(g - 10000) < 1) return 'Silver';
    if(Math.abs(a - 5.5) < 0.001 && Math.abs(g - 40000) < 1) return 'Gold';
  }
  return null;
}

function addDays(dt, days){
  const out = new Date(dt.getTime());
  out.setDate(out.getDate() + days);
  return out;
}

/* Reset rule: if claim hour < 8 => counts for previous calendar day */
function adjustClaimForReset(claimDate){
  const adj = new Date(claimDate.getTime());
  if(adj.getHours() < 8) adj.setDate(adj.getDate() - 1);
  adj.setHours(0,0,0,0);
  return adj;
}

function startMidnight(dt){
  const s = new Date(dt.getTime()); s.setHours(0,0,0,0); return s;
}

/* compute intervals (stacking) */
function computeIntervals(purchases){
  const byType = {};
  for(const p of purchases){
    if(!p.type) continue;
    if(!byType[p.type]) byType[p.type] = [];
    byType[p.type].push(p);
  }
  const result = {};
  for(const type of Object.keys(byType)){
    const arr = byType[type].slice().sort((a,b)=>a.updated - b.updated);
    const intervals = [];
    for(const p of arr){
      const start = p.updated;
      const durationDays = 7;
      if(intervals.length === 0){
        intervals.push({ start: new Date(start), end: addDays(start, durationDays), purchases: [p] });
      } else {
        const cur = intervals[intervals.length-1];
        // extend from current end if purchase occurs on or before it
        if(start <= cur.end){
          cur.end = addDays(cur.end, durationDays);
          cur.purchases.push(p);
        } else {
          intervals.push({ start: new Date(start), end: addDays(start, durationDays), purchases: [p] });
        }
      }
    }
    result[type] = intervals;
  }
  return result;
}

/* Map claims to intervals */
function matchClaimsToIntervals(intervalsByType, claims){
  const result = {};
  for(const type of Object.keys(intervalsByType)){
    result[type] = [];
    for(const iv of intervalsByType[type]){
      const days = [];
      const startMid = startMidnight(iv.start);
      for(let i=0;i<7;i++){
        const dayDate = new Date(startMid.getTime()); dayDate.setDate(dayDate.getDate()+i);
        days.push({ dayIndex: i, dateLabel: `${dayDate.getFullYear()}-${String(dayDate.getMonth()+1).padStart(2,'0')}-${String(dayDate.getDate()).padStart(2,'0')}`, claimTimes: [] });
      }
      for(const c of claims){
        if(c.type !== type) continue;
        if(c.creatingTime >= iv.start && c.creatingTime < iv.end){
          const adj = adjustClaimForReset(c.creatingTime);
          const diff = Math.floor((adj - startMid) / (24*3600*1000));
          if(diff >= 0 && diff < 7) days[diff].claimTimes.push(c.creatingTime);
        }
      }
      for(const d of days) d.claimed = (d.claimTimes.length > 0);
      result[type].push({ interval: iv, days });
    }
  }
  return result;
}

/* ==========================
   UI + main flows
   ========================== */

function clearAll(){
  document.getElementById('box1').value = '';
  document.getElementById('box2').value = '';
  document.getElementById('results').innerHTML = '';
}

function summaryOnly(){
  const parsed = parseAndFilterPurchases();
  if(!parsed) return;
  const ints = computeIntervals(parsed.purchases);
  renderSummary(ints, {});
}

function parseAndFilterPurchases(){
  const text = document.getElementById('box1').value;
  if(!text.trim()){ alert('Please paste Box 1 (purchases).'); return null; }
  const parsed = parseCSV(text);
  const headers = parsed.headers; const rows = parsed.rows;
  const findKey = key => headers.find(h => h.trim().toLowerCase() === key.toLowerCase()) || null;
  const H_STATUS = findKey('Status');
  const H_UPDATED = findKey('Updated');
  const H_PURCHASE_TYPE = findKey('Purchase Type') || findKey('PurchaseType') || findKey('purchase_type');
  const H_AMOUNT = findKey('Amount');
  if(!H_STATUS || !H_UPDATED || !H_PURCHASE_TYPE || !H_AMOUNT){
    const missing = [];
    if(!H_STATUS) missing.push('Status');
    if(!H_UPDATED) missing.push('Updated');
    if(!H_PURCHASE_TYPE) missing.push('Purchase Type');
    if(!H_AMOUNT) missing.push('Amount');
    alert('Missing required header(s) in Box 1: ' + missing.join(', '));
    return null;
  }
  const purchases = [];
  for(const r of rows){
    const purchaseTypeRaw = r[H_PURCHASE_TYPE];
    if(!purchaseTypeRaw) continue;
    if(String(purchaseTypeRaw).trim().toLowerCase() !== 'sub_pack') continue;
    if(!isSuccess(r[H_STATUS])) continue;
    const dt = parseDateFlexible(r[H_UPDATED]); if(!dt) continue;
    const type = amountToType(r[H_AMOUNT]); if(!type) continue;
    purchases.push({ type, updated: dt, amount: Number(stripNumber(r[H_AMOUNT])), raw: r });
  }
  return { purchases };
}

function parseClaims(){
  const text = document.getElementById('box2').value;
  if(!text.trim()) return []; // empty allowed
  const parsed = parseCSV(text);
  const headers = parsed.headers; const rows = parsed.rows;
  const findKey = key => headers.find(h => h.trim().toLowerCase() === key.toLowerCase()) || null;
  const H_UNPLAYED = findKey('Unplayed SC') || findKey('UnplayedSC') || findKey('Unplayed_SC') || findKey('unplayed sc');
  const H_GC = findKey('GC') || findKey('Gc') || findKey('gc');
  const H_CREATING = findKey('Creating Time') || findKey('CreatingTime') || findKey('creating_time') || findKey('created') || findKey('timestamp') || headers.find(h=>/time|created|creating|timestamp/i.test(h));
  if(!H_UNPLAYED || !H_GC || !H_CREATING){
    alert('Box 2 must include: Unplayed SC, GC, Creating Time (case-insensitive). Please include these headers.');
    return null;
  }
  const claims = [];
  for(const r of rows){
    const unplayed = r[H_UNPLAYED];
    const gc = r[H_GC];
    const dt = parseDateFlexible(r[H_CREATING]);
    if(!dt) continue;
    const type = detectClaimType(unplayed, gc);
    claims.push({ type, creatingTime: dt, raw: r, unplayed, gc });
  }
  return claims;
}

function analyzeAll(){
  const parsed = parseAndFilterPurchases();
  if(!parsed) return;
  const purchases = parsed.purchases;
  const intervalsByType = computeIntervals(purchases);
  const claims = parseClaims();
  if(claims === null) return;
  const claimsFiltered = claims.filter(c => c.type !== null);
  const mapping = matchClaimsToIntervals(intervalsByType, claimsFiltered);
  renderSummary(intervalsByType, mapping);
}

/* Render — Option A (table per type) + calendar + collapsed details */
function renderSummary(intervalsByType, claimsMapping){
  const out = document.getElementById('results');
  let html = '';
  // top summary cards
  let totalIntervals = 0;
  ['Bronze','Silver','Gold'].forEach(t => { if(intervalsByType[t]) totalIntervals += intervalsByType[t].length; });
  html += `<div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px;">`;
  html += `<div style="background:#fff;padding:10px;border-radius:8px;border:1px solid #eee;min-width:140px;"><div class="small-muted">Total Intervals</div><div style="font-weight:700;font-size:18px;margin-top:6px;">${totalIntervals}</div></div>`;
  ['Bronze','Silver','Gold'].forEach(t=>{
    const count = (intervalsByType[t]||[]).length;
    html += `<div style="background:#fff;padding:10px;border-radius:8px;border:1px solid #eee;min-width:140px;"><div class="small-muted">${t}</div><div style="font-weight:700;font-size:18px;margin-top:6px;">${count}</div></div>`;
  });
  html += `</div>`;

  // now per type
  const now = new Date();
  for(const t of ['Bronze','Silver','Gold']){
    const intervals = intervalsByType[t] || [];
    const badgeClass = t==='Bronze' ? 'badge bronze' : (t==='Silver' ? 'badge silver' : 'badge gold');
    html += `<div class="type-section">`;
    html += `<div class="type-header"><div class="type-title"><span class="${badgeClass}">${t}</span><div class="small-muted">${intervals.length} interval(s)</div></div></div>`;

    if(intervals.length === 0){
      html += `<div class="muted" style="margin-top:10px;">No intervals.</div>`;
      html += `</div>`; continue;
    }

    intervals.forEach((iv, idx) => {
      // build days array (7 days), prefer mapping if present
      let days = [];
      const startMid = startMidnight(iv.start);
      for(let i=0;i<7;i++){
        const dd = new Date(startMid.getTime()); dd.setDate(dd.getDate()+i);
        days.push({ dayIndex: i, dateLabel: `${dd.getFullYear()}-${String(dd.getMonth()+1).padStart(2,'0')}-${String(dd.getDate()).padStart(2,'0')}`, claimTimes: [], claimed: false });
      }
      const mapped = (claimsMapping[t] && claimsMapping[t][idx]) ? claimsMapping[t][idx].days : null;
      if(mapped && mapped.length === 7){
        for(let i=0;i<7;i++){
          days[i].claimed = mapped[i].claimed;
          days[i].claimTimes = mapped[i].claimTimes.slice();
        }
      }
      // calendar row
      html += `<div style="margin-top:10px;"><strong>Interval ${idx+1}</strong> — ${fmt(iv.start)} → ${fmt(iv.end)} (purchases: ${iv.purchases.length})</div>`;
      html += `<div class="cal-container">`;
      html += `<div class="calendar-grid">`;
      for(const d of days){
        const [yyyy,mm,dd] = d.dateLabel.split('-').map(x=>Number(x));
        const dayMid = new Date(yyyy,mm-1,dd,0,0,0);
        let css = 'cal-missed';
        if(d.claimed) css = 'cal-claimed';
        else if(dayMid.getTime() > now.getTime()) css = 'cal-future';
        html += `<div class="cal-day ${css}"><div class="cal-header">Day ${d.dayIndex+1}</div>${d.dateLabel}</div>`;
      }
      html += `</div>`; // calendar-grid
      html += `</div>`; // cal-container

      // collapsed details toggle button
      const detailsId = `details_${t}_${idx}`;
      html += `<div style="margin-top:8px;"><button class="inline-btn" aria-expanded="false" onclick="toggleDetails('${detailsId}', this)">Show Details ▼</button></div>`;

      // details container (collapsed by default)
      html += `<div id="${detailsId}" class="details-wrap">`;
      html += `<div class="details-body">`;
      // per-day rows
      for(const d of days){
        const [yyyy,mm,dd] = d.dateLabel.split('-').map(x=>Number(x));
        const dayMid = new Date(yyyy,mm-1,dd,0,0,0);
        let statusLabel = '';
        let statusClass = '';
        if(d.claimed){ statusLabel = 'Claimed'; statusClass = 'status-claimed'; }
        else if(dayMid.getTime() > now.getTime()){ statusLabel = 'To be Claimed'; statusClass = 'status-future'; }
        else { statusLabel = 'Not Claimed'; statusClass = 'status-missed'; }
        html += `<div class="day-row"><div class="day-label">Day ${d.dayIndex+1} — ${d.dateLabel}</div><div style="flex:1"><div class="${statusClass}">${statusLabel}</div>`;
        if(d.claimTimes && d.claimTimes.length){
          html += `<div class="claim-times" style="margin-top:6px;">${d.claimTimes.map(ct=>fmt(ct)).map(x=>escapeHtml(x)).join('<br>')}</div>`;
        } else {
          html += `<div class="muted" style="margin-top:6px;">No claim timestamps</div>`;
        }
        html += `</div></div>`;
      }
      html += `</div></div>`; // details-body & details-wrap
    });

    html += `</div>`; // type-section
  }

  out.innerHTML = html;
  out.scrollIntoView({ behavior: 'smooth' });
}

/* Toggle details (smooth slide) */
function toggleDetails(id, btn){
  const el = document.getElementById(id);
  if(!el) return;
  const isOpen = el.classList.contains('open');
  if(isOpen){
    el.classList.remove('open');
    btn.innerText = 'Show Details ▼';
    btn.setAttribute('aria-expanded','false');
  } else {
    el.classList.add('open');
    btn.innerText = 'Hide Details ▲';
    btn.setAttribute('aria-expanded','true');
  }
}

/* escape helper */
function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
</script>
</body>
</html>
