<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Weekly Subscription Analyzer</title>
<style>
 body { font-family: Arial, sans-serif; padding: 20px; }
 h2 { margin-top: 30px; }
 textarea { width: 100%; height: 180px; font-family: monospace; }
 table { border-collapse: collapse; width: 100%; margin-top: 10px; }
 th, td { border: 1px solid #ccc; padding: 6px; font-size: 14px; }
 .bronze { background: #cd7f32; color: white; }
 .silver { background: #c0c0c0; color: black; }
 .gold { background: #ffd700; color: black; }
 .grid { display: grid; grid-template-columns: repeat(7, 1fr); margin-top: 10px; }
 .day { border: 1px solid #ccc; padding: 4px; height: 70px; font-size: 12px; }
 .claimed { background: #c6efce; }
 .missed { background: #ffc7ce; }
 .future { background: #d9d9d9; }
 #purchasesTableWrap { display:none; margin-top:20px; }
</style>
</head>
<body>
<h1>Weekly Subscription Analyzer</h1>

<h2>Purchases Data (Box 1)</h2>
<textarea id="box1" placeholder="Paste Purchases Data here..."></textarea>
<button onclick="convertPurchases()" style="padding:8px 20px; margin-top:5px;">Convert Purchases</button>
<div id="purchasesTableWrap"></div>

<h2>Game Flow Data (Box 2)</h2>
<textarea id="box2" placeholder="Paste Game Flow Data here..."></textarea>

<button onclick="analyze()" style="padding:10px 25px; margin-top:20px; font-size:16px;">Analyze Subscriptions</button>

<h2>Results</h2>
<div id="results"></div>

<script>
let PURCHASES = { headers: [], rows: [] };

function parseTS(x){ return new Date(x.replace(/\s+/,'T')); }

function convertPurchases() {
  const raw = document.getElementById('box1').value || '';
  const lines = raw.replace(/\r/g, '').split('\n').map(l => l.trim()).filter(l => l.length > 0);
  if (lines.length === 0) {
    alert('Paste Purchases Data first');
    return;
  }

  const headers = ['Status','Updated','App Order Id','Order No','Channel','Purchase ID','Purchase Type','Amount'];
  const rows = [];

  let startIdx = 0;
  if (lines[0].toLowerCase().includes('status')) startIdx = 1;

  for (let i = startIdx; i < lines.length; i += 4) {
    if (i + 3 >= lines.length) break;
    const status = lines[i];
    const lineB = lines[i + 1].split('\t').map(x => x.trim());
    const updated = lineB[0] || '';
    const appOrderId = lineB[1] || '';
    const orderNo = lineB[2] || '';
    const channel = lineB[3] || '';
    const purchaseId = lineB[4] || '';
    const purchaseType = lines[i + 2];
    const amount = lines[i + 3];

    rows.push({
      'Status': status,
      'Updated': updated,
      'App Order Id': appOrderId,
      'Order No': orderNo,
      'Channel': channel,
      'Purchase ID': purchaseId,
      'Purchase Type': purchaseType,
      'Amount': amount
    });
  }

  PURCHASES = { headers, rows };
  renderPurchasesTable();
}

function renderPurchasesTable() {
  const wrap = document.getElementById('purchasesTableWrap');
  if (!wrap) return;
  const { headers, rows } = PURCHASES;
  let html = '<table><thead><tr>';
  headers.forEach(h => html += `<th>${h}</th>`);
  html += '</tr></thead><tbody>';
  rows.forEach(r => {
    html += '<tr>';
    headers.forEach(h => html += `<td>${r[h]}</td>`);
    html += '</tr>';
  });
  html += '</tbody></table>';
  wrap.innerHTML = html;
  wrap.style.display = 'block';
}

function analyze(){
 if(PURCHASES.rows.length === 0){
   alert('Please convert Purchases first');
   return;
 }

 const b2 = document.getElementById('box2').value.trim().split(/\n/);
 let claims=[];
 for(let i=1;i<b2.length;i++){
   let line=b2[i].split('\t');
   if(line.length < 10) continue;
   let unplayed=parseFloat(line[1]);
   let gc=parseFloat(line[2]);
   let ts=line[9].trim();
   let tier=null;
   if(unplayed===0.5 && gc===2000) tier='Bronze';
   if(unplayed===2 && gc===10000) tier='Silver';
   if(unplayed===5.5 && gc===40000) tier='Gold';
   if(!tier) continue;
   claims.push({tier, ts:parseTS(ts)});
 }

 let subs=[];
 PURCHASES.rows.forEach(p=>{
   if(p['Purchase Type']!=='sub_pack') return;
   if(p['Status']!=='Succeed') return;
   const amt = parseFloat(p['Amount']);
   let tier = amt===7? 'Bronze': amt===30? 'Silver': amt===90? 'Gold': null;
   if(!tier) return;
   const start = parseTS(p['Updated']);
   const end = new Date(start.getTime()+7*24*3600*1000);
   subs.push({tier,start,end});
 });

 let html='';
 subs.forEach((s,idx)=>{
   const color = s.tier==='Bronze'?'bronze':s.tier==='Silver'?'silver':'gold';
   html += `<h3 class="${color}">${s.tier} Subscription (${s.start.toLocaleString()} â†’ ${s.end.toLocaleString()})</h3>`;
   let days=[];
   for(let d=0; d<7; d++){
     let dayStart = new Date(s.start.getTime()+d*86400000);
     let dayEnd = new Date(dayStart.getTime()+86400000);
     let claim = claims.find(c=>c.tier===s.tier && c.ts>=dayStart && c.ts<dayEnd);
     let today = new Date();
     let cls = claim? 'claimed': (dayEnd>today? 'future':'missed');
     days.push(`<div class="day ${cls}"><b>Day ${d+1}</b><br>${dayStart.toLocaleDateString()}${claim? '<br>Claimed':''}${cls==='future'?'<br>Future':''}${cls==='missed'?'<br>Not Claimed':''}</div>`);
   }
   html += `<div class="grid">${days.join('')}</div>`;
 });

 document.getElementById('results').innerHTML = html;
}
</script>

<p style="margin-top:40px; font-size:12px;">Signature by: Paul P</p>
</body>
</html>
