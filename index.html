<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Weekly Subscription Analyzer</title>
<style>
 body { font-family: Arial, sans-serif; padding: 20px; }
 h2 { margin-top: 30px; }
 textarea { width: 100%; height: 180px; font-family: monospace; }
 table { border-collapse: collapse; width: 100%; margin-top: 10px; }
 th, td { border: 1px solid #ccc; padding: 6px; font-size: 14px; }
 .bronze { background: #cd7f32; color: white; }
 .silver { background: #c0c0c0; color: black; }
 .gold { background: #ffd700; color: black; }
 .grid { display: grid; grid-template-columns: repeat(7, 1fr); margin-top: 10px; }
 .day { border: 1px solid #ccc; padding: 4px; height: 70px; font-size: 12px; }
 .claimed { background: #c6efce; }
 .missed { background: #ffc7ce; }
 .future { background: #d9d9d9; }
</style>
</head>
<body>
<h1>Weekly Subscription Analyzer</h1>

<h2>Purchases Data</h2>
<textarea id="box1" placeholder="Paste Purchases Data here..."></textarea>

<h2>Game Flow Data</h2>
<textarea id="box2" placeholder="Paste Game Flow Data here..."></textarea>

<button onclick="analyze()" style="padding:10px 25px; margin-top:20px; font-size:16px;">Analyze Subscription</button>

<h2>Results</h2>
<div id="results"></div>

<script>
function parseTS(x){
    return new Date(x.replace(/\s+/,'T'));
}

function adjustFor8AM(date){
    let d = new Date(date);
    if(d.getHours() < 8){
        d.setDate(d.getDate() - 1);
    }
    return d;
}

function analyze(){
    const b1 = document.getElementById('box1').value.trim().split(/\n/);
    const b2 = document.getElementById('box2').value.trim().split(/\n/);

    // Parse Purchases
    let subs = [];
    for(let i=0; i<b1.length; i+=4){
        let status = b1[i].trim();
        let updated = b1[i+1].trim().split(/\t+/)[0]; // take timestamp
        let ptype = b1[i+2].trim();
        let amt = parseFloat(b1[i+3].trim());
        if(ptype!=='sub_pack') continue;
        if(status!=='Succeed') continue;

        let tier = amt===7? 'Bronze': amt===30? 'Silver': amt===90? 'Gold': null;
        if(!tier) continue;

        let start = parseTS(updated);
        start = adjustFor8AM(start);

        // Check for overlapping subscriptions of same tier
        let overlap = subs.find(s=>s.tier===tier && s.end >= start);
        if(overlap){
            overlap.end = new Date(overlap.end.getTime() + 7*24*3600*1000);
        } else {
            let end = new Date(start.getTime() + 7*24*3600*1000);
            subs.push({tier,start,end});
        }
    }

    // Parse Game Flow (claims)
    let claims = [];
    for(let i=0; i<b2.length; i+=3){
        let ts = b2[i+2].trim();
        let unplayed = parseFloat(b2[i].split(/\t+/)[1]); // example mapping
        let gc = parseFloat(b2[i].split(/\t+/)[2]);
        let tier = null;
        if(unplayed===0.5 && gc===2000) tier='Bronze';
        if(unplayed===2 && gc===10000) tier='Silver';
        if(unplayed===5.5 && gc===40000) tier='Gold';
        if(!tier) continue;
        let cts = parseTS(ts);
        cts = adjustFor8AM(cts);
        claims.push({tier, ts:cts});
    }

    // Generate HTML
    let html = '';
    subs.forEach(s=>{
        const color = s.tier==='Bronze'?'bronze':s.tier==='Silver'?'silver':'gold';
        html += `<h3 class="${color}">${s.tier} Subscription (${s.start.getFullYear()}-${String(s.start.getMonth()+1).padStart(2,'0')}-${String(s.start.getDate()).padStart(2,'0')} ${String(s.start.getHours()).padStart(2,'0')}:${String(s.start.getMinutes()).padStart(2,'0')} â†’ ${s.end.getFullYear()}-${String(s.end.getMonth()+1).padStart(2,'0')}-${String(s.end.getDate()).padStart(2,'0')} ${String(s.end.getHours()).padStart(2,'0')}:${String(s.end.getMinutes()).padStart(2,'0')})</h3>`; 

        let days = [];
        let current = new Date(s.start);
        let dayCount = 1;
        while(current < s.end && dayCount <= 7){
            let nextDay = new Date(current);
            if(dayCount === 1){
                // Day 1 ends at 08:00 next day
                let dayEnd = new Date(current);
                dayEnd.setDate(dayEnd.getDate()+1);
                dayEnd.setHours(8,0,0,0);
                nextDay = dayEnd;
            } else {
                nextDay.setHours(8,0,0,0);
                nextDay.setDate(nextDay.getDate()+1);
            }

            let claim = claims.find(c=>c.tier===s.tier && c.ts >= current && c.ts < nextDay);
            let today = new Date();
            let cls = claim? 'claimed': (nextDay>today? 'future':'missed');
            days.push(`<div class="day ${cls}"><b>Day ${dayCount}</b><br>${current.getFullYear()}-${String(current.getMonth()+1).padStart(2,'0')}-${String(current.getDate()).padStart(2,'0')} ${String(current.getHours()).padStart(2,'0')}:${String(current.getMinutes()).padStart(2,'0')}${claim? '<br>Claimed':''}${cls==='future'?'<br>Future':''}${cls==='missed'?'<br>Not Claimed':''}</div>`);

            current = nextDay;
            dayCount++;
        }
        html += `<div class="grid">${days.join('')}</div>`;
    });

    document.getElementById('results').innerHTML = html;
}
</script>

<p style="margin-top:40px; font-size:12px;">Signature by: Paul P</p>
</body>
</html>
