<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Subscription Analyzer</title>
<style>
body { font-family: Arial, sans-serif; padding: 20px; }
textarea { width: 100%; font-family: monospace; margin-bottom: 10px; }
button { padding: 10px 20px; font-size: 16px; margin-bottom: 20px; }

.container {
  display: flex;
  gap: 20px;
  align-items: flex-start;
}

.left-box, .right-box {
  flex: 1;
  display: flex;
  flex-direction: column;
}

.left-box .left-content {
  display: flex;
  flex-direction: column;
}

.right-box {
  border: 1px solid #ccc;
  padding: 10px;
  background: #f9f9f9;
  justify-content: flex-start;
}

textarea.purchase, textarea.claim { height: 80px; resize: vertical; }

/* Columns for each Sub Pack */
.tables-container { display: flex; gap: 20px; align-items: flex-start; }
.pack-column { flex: 1; display: flex; flex-direction: column; }

/* Colored Sub Pack headers */
.pack-header { font-size: 18px; font-weight: bold; margin-bottom: 5px; text-align: center; padding: 6px; border-radius: 4px; }

/* Tables inside each column stack vertically */
.table-box { display: block; margin-bottom: 10px; }
table { border-collapse: collapse; table-layout: fixed; white-space: nowrap; font-size: 14px; width: 100%; }
th, td { border: 1px solid #999; padding: 4px 6px; text-align: left; overflow: hidden; text-overflow: ellipsis; }

/* Adjusted column widths */
th:nth-child(1), td:nth-child(1) { width: 50px; }       /* Day */
th:nth-child(2), td:nth-child(2) { width: 320px; }     /* Day Range - wider */
th:nth-child(3), td:nth-child(3) { width: 150px; }     /* Status - wider */
th:nth-child(4), td:nth-child(4) { width: 90px; }      /* Server Time - narrower */

.total-days { width: 50px; background: #fff3b0; font-weight: bold; text-align: center; }
.claimed { background: #c8f7c5; color: #155724; font-weight: bold; }
.missed { background: #f8d0d0; color: #8b0000; font-weight: bold; }

.summary-title { font-weight: bold; margin-bottom: 10px; }
.summary-item { margin-bottom: 6px; padding: 4px 6px; border-radius: 4px; color: #000; font-weight: bold; }
.summary-sub7 { background: #cce5ff; }
.summary-sub30 { background: #d4edda; }
.summary-sub90 { background: #fff3cd; }
</style>
</head>
<body>

<h2>Subscription Analyzer</h2>

<div class="container">
  <div class="left-box">
    <div class="left-content">
      <label>Purchase Data (compressed, 7-column, tab- or space-separated):</label>
      <textarea id="purchaseData" class="purchase"></textarea>

      <label>Claim Data (3-line per claim):</label>
      <textarea id="claimData" class="claim"></textarea>

      <button onclick="analyze()">Analyze</button>
    </div>
  </div>

  <div class="right-box" id="summaryBox">
    <div class="summary-title">Purchase Summary</div>
    <div id="summaryContent">No data yet.</div>
  </div>
</div>

<div id="results" class="tables-container"></div>

<script>
const PACKS = {
  7.00: {name: "Sub Pack 07", sc: 0.50, gc: 2000},
  30.00: {name: "Sub Pack 30", sc: 2.00, gc: 10000},
  90.00: {name: "Sub Pack 90", sc: 5.50, gc: 40000}
};

// ------------------ Parse Purchases ------------------
function parsePurchases(text){
  const lines = text.trim().split('\n').map(l=>l.trim()).filter(l=>l);
  const purchases=[];
  for(let i=0;i<lines.length;i++){
    if(lines[i].toLowerCase().includes("sub_pack")){
      const prev = i>0 ? lines[i-1] : null;
      if(!prev) continue;
      const ts = new Date(prev.split(/\s+/)[0]); // support tabs or spaces
      const nextLine = (i+1)<lines.length ? lines[i+1] : lines[i];
      const amtMatch = nextLine.match(/\d+(\.\d+)?/);
      if(!amtMatch) continue;
      const amt = parseFloat(amtMatch[0]);
      if(PACKS[amt]) purchases.push({purchase_ts: ts, pack_amount: amt, pack_name: PACKS[amt].name});
    }
  }
  return purchases;
}

// ------------------ Parse Claims ------------------
function parseClaims(text){
  const lines = text.trim().split('\n').map(l=>l.trim()).filter(l=>l);
  const claims = [];
  for(let i=0;i<lines.length;i+=3){
    const line1 = lines[i].split(/\s+/);
    if(line1.length < 2) continue;
    const sc = parseFloat(line1[0]);
    const gc = parseFloat(line1[1]);
    const line3 = lines[i+2] || '';
    const dateMatch = line3.match(/\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}/);
    if(!dateMatch) continue;
    const ts = new Date(dateMatch[0]);

    let pack_amount = null;
    for(let amt in PACKS){
      if(PACKS[amt].sc === sc && PACKS[amt].gc === gc){
        pack_amount = parseFloat(amt);
        break;
      }
    }
    if(pack_amount) claims.push({pack_amount, claim_ts: ts});
  }
  return claims;
}

// ------------------ Format Dates ------------------
function formatDate(date){
  const pad = n=>n.toString().padStart(2,"0");
  return `${date.getFullYear()}-${pad(date.getMonth()+1)}-${pad(date.getDate())} ${pad(date.getHours())}:${pad(date.getMinutes())}`;
}
function formatDateOnly(date){
  const pad = n=>n.toString().padStart(2,"0");
  return `${date.getFullYear()}-${pad(date.getMonth()+1)}-${pad(date.getDate())}`;
}

// ------------------ Compute Day Ranges ------------------
function computeDayRanges(purchase_ts, totalDays){
  const ranges=[];
  let start = new Date(purchase_ts);
  for(let d=1; d<=totalDays; d++){
    let end = new Date(start);
    if(d===1){
      if(start.getHours()>=8){ end.setDate(end.getDate()+1); }
      end.setHours(8,0,0,0);
    } else {
      start = new Date(ranges[ranges.length-1].end);
      end = new Date(start);
      end.setDate(end.getDate()+1);
      end.setHours(8,0,0,0);
    }
    ranges.push({day:d, start:new Date(start), end:new Date(end)});
    start = end;
  }
  return ranges;
}

// ------------------ Create Table ------------------
function createTable(interval, totalDays, claims){
  const tableBox=document.createElement("div");
  tableBox.className="table-box";

  const table=document.createElement("table");

  // Total days row
  let row2 = table.insertRow();
  let c2a = row2.insertCell();
  c2a.innerText = `Total: ${totalDays} days`;
  c2a.className = "total-days";
  let c2b = row2.insertCell();
  c2b.colSpan = 3;
  const lastRange = computeDayRanges(interval.purchase_ts, totalDays);
  c2b.innerText = `Start: ${formatDate(lastRange[0].start)} | End: ${formatDate(lastRange[lastRange.length-1].end)}`;

  // Table headers
  let row3=table.insertRow();
  ["Day","Day Range","Status","Server Time"].forEach(h=>{
    let th=document.createElement("th"); th.innerText=h; row3.appendChild(th);
  });

  // Day rows
  lastRange.forEach(r=>{
    let row=table.insertRow();
    row.insertCell().innerText="Day "+r.day;
    row.insertCell().innerText=`${formatDate(r.start)} → ${formatDate(r.end)}`;

    let statusCell = row.insertCell();
    let pstCell = row.insertCell();

    let matchedClaim = claims.find(c=>c.pack_amount===interval.pack_amount && c.claim_ts>=r.start && c.claim_ts<=r.end);
    if(matchedClaim){
      const claimText = formatDate(matchedClaim.claim_ts);
      statusCell.innerText = `Claimed: ${claimText}`;
      statusCell.className = "claimed";

      let pstDate = new Date(matchedClaim.claim_ts);
      pstDate.setHours(pstDate.getHours() - 8);
      pstCell.innerText = formatDate(pstDate);
    } else {
      statusCell.innerText = "Missed";
      statusCell.className = "missed";
      pstCell.innerText = "";
    }
  });

  tableBox.appendChild(table);
  return tableBox;
}

// ------------------ Update Summary ------------------
function updateSummary(purchases){
  const summaryDiv = document.getElementById("summaryContent");
  summaryDiv.innerHTML = "";
  for(let amt in PACKS){
    const packName = PACKS[amt].name;
    let packPurchases = purchases.filter(p=>p.pack_amount===parseFloat(amt));
    const dates = packPurchases.map(p=>formatDateOnly(p.purchase_ts));

    let itemDiv = document.createElement("div");
    itemDiv.className = "summary-item";
    if(parseFloat(amt) === 7) itemDiv.classList.add("summary-sub7");
    else if(parseFloat(amt) === 30) itemDiv.classList.add("summary-sub30");
    else if(parseFloat(amt) === 90) itemDiv.classList.add("summary-sub90");

    if(dates.length === 0){
      itemDiv.innerText = `${packName}: 0 purchases → -`;
    } else {
      itemDiv.innerText = `${packName}: ${dates.length} purchase${dates.length>1?'s':''} → ${dates.join(', ')}`;
    }

    summaryDiv.appendChild(itemDiv);
  }
}

// ------------------ Main Analyze ------------------
function analyze(){
  const purchases=parsePurchases(document.getElementById("purchaseData").value);
  const claims=parseClaims(document.getElementById("claimData").value);
  const resultsDiv=document.getElementById("results");
  resultsDiv.innerHTML="";

  updateSummary(purchases);

  // Create columns for each pack type with colored headers
  const columns = {};
  for(let amt in PACKS){
    const colDiv = document.createElement("div");
    colDiv.className="pack-column";

    const header = document.createElement("div");
    header.className="pack-header";
    header.innerText = PACKS[amt].name;
    if(parseFloat(amt)===7) header.style.background="#cce5ff";    // light blue
    else if(parseFloat(amt)===30) header.style.background="#d4edda"; // light green
    else if(parseFloat(amt)===90) header.style.background="#fff3cd"; // light yellow
    colDiv.appendChild(header);

    resultsDiv.appendChild(colDiv);
    columns[amt]=colDiv;
  }

  // Loop through purchases per pack
  for(let amt in PACKS){
    let packPurchases = purchases
      .filter(p=>p.pack_amount===parseFloat(amt))
      .sort((a,b)=>a.purchase_ts-b.purchase_ts);

    let intervals=[];

    for(let p of packPurchases){
      const last = intervals[intervals.length-1];
      if(last){
        const lastEnd = new Date(last.purchase_ts.getTime() + (last.totalDays||7)*24*3600*1000);
        if(p.purchase_ts <= lastEnd){
          // extend existing interval
          last.totalDays = ((lastEnd.getTime() + 7*24*3600*1000) - last.purchase_ts.getTime())/(24*3600*1000);
          continue;
        } else {
          intervals.push({pack_name: PACKS[amt].name, pack_amount: parseFloat(amt), purchase_ts: p.purchase_ts, totalDays:7});
        }
      } else {
        intervals.push({pack_name: PACKS[amt].name, pack_amount: parseFloat(amt), purchase_ts: p.purchase_ts, totalDays:7});
      }
    }

    intervals.forEach(in
