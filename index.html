<style>
body { font-family: Arial, sans-serif; padding: 20px; }
h2 { margin-top: 20px; }
 textarea { width: 100%; font-family: monospace; }
 .input-container { display: flex; gap: 10px; }
 .input-box { flex: 1; display: flex; flex-direction: column; }
 textarea { width: 100%; height: 120px; font-family: monospace; margin-bottom: 10px; }
table { border-collapse: collapse; width: 100%; margin-top: 10px; }
th, td { border: 1px solid #ccc; padding: 6px; font-size: 14px; }
.bronze { background: #cd7f32; color: white; }
@@ -21,88 +19,129 @@
.missed { background: #ffc7ce; }
.future { background: #d9d9d9; }
.extended { border: 2px dashed #000; }
 .right-panel { margin-top: 20px; }
 .flex { display: flex; gap: 20px; }
 .half { width: 50%; }
</style>
</head>
<body>
<h1>Weekly Subscription Analyzer</h1>

<div class="input-container">
  <div class="input-box">
    <h2>Purchases Data</h2>
    <textarea id="box1" placeholder="Paste Purchases Data here..." rows="10"></textarea>
  </div>
  <div class="input-box">
    <h2>Game Flow Data</h2>
    <textarea id="box2" placeholder="Paste Game Flow Data here..." rows="10"></textarea>
  </div>
</div>
<div class="flex">
 <div class="half">
   <h2>Purchases Data</h2>
   <textarea id="box1" placeholder="Paste Purchases Data here..."></textarea>

   <h2>Game Flow Data</h2>
   <textarea id="box2" placeholder="Paste Game Flow Data here..."></textarea>

<button onclick="analyze()" style="padding:10px 25px; margin-top:20px; font-size:16px;">Analyze Subscription</button>
   <button onclick="analyze()" style="padding:10px 25px; margin-top:10px; font-size:16px;">Analyze Subscription</button>
 </div>

<div class="right-panel">
  <h2>Valid Subscriptions</h2>
  <div id="validSubs"></div>
 <div class="half">
   <h2>Valid Subscriptions</h2>
   <div id="validSubs"></div>
 </div>
</div>

<h2>Results</h2>
<h2>Analyzed Subscription Grid</h2>
<div id="results"></div>

<script>
function parseTS(x){ return new Date(x.replace(/\s+/,'T')); }
function parseTS(x){
  return new Date(x.replace(/\s+/,'T'));
}

// Adjust date for 08:00 reset
function adjustDateForReset(d){
  let dt = new Date(d);
  if(dt.getHours() < 8){
    dt.setDate(dt.getDate() - 1);
  }
  return dt;
}

function analyze(){
 const b1 = document.getElementById('box1').value.trim().split(/\n/);
 const b2 = document.getElementById('box2').value.trim().split(/\n/);
 let subs=[];
 for(let i=0;i<b1.length;i+=4){
   let status = b1[i].trim();
   let updated = b1[i+1]?.trim();
   let ptype = b1[i+2]?.trim();
   let amt = parseFloat(b1[i+3]);
   if(!status || !updated || !ptype || isNaN(amt)) continue;
   if(ptype!=='sub_pack' && ptype!=='start_pack' && ptype!=='Bronze' && ptype!=='Silver' && ptype!=='Gold') continue;
   let tier = amt===7? 'Bronze': amt===30? 'Silver': amt===90? 'Gold': ptype;
   let start = parseTS(updated);
   subs.push({tier,start,amt,originalStart: new Date(start)});
 }
  const b1 = document.getElementById('box1').value.trim().split(/\n/);
  const b2 = document.getElementById('box2').value.trim().split(/\n/);

  let subs=[];
  // Read Purchases data: 4 lines per purchase
  for(let i=0; i<b1.length; i+=4){
    const status = b1[i].trim();
    const updated = b1[i+1]?.trim();
    const ptype = b1[i+2]?.trim();
    const amt = parseFloat(b1[i+3]);
    if(!status || status!=='Succeed') continue;
    if(ptype!=='sub_pack' && ptype!=='start_pack' && ptype!=='bronze' && ptype!=='silver' && ptype!=='gold') continue;
    let tier = ptype==='sub_pack'? 'Bronze': ptype==='start_pack'? 'Silver': ptype==='gold'? 'Gold': 'Bronze';
    let start = parseTS(updated);
    subs.push({tier, start, amt, originalStart: start, extended: false});
  }

 // Generate valid subscriptions list
 let validHTML = '<table><tr><th>Tier</th><th>Purchase Date</th><th>Amount</th></tr>';
 subs.forEach(s=>{
   validHTML += `<tr><td>${s.tier}</td><td>${s.start.toISOString().slice(0,19).replace('T',' ')}</td><td>${s.amt}</td></tr>`;
 });
 validHTML += '</table>';
 document.getElementById('validSubs').innerHTML = validHTML;
  // Merge overlapping subscriptions
  subs.sort((a,b)=>a.start-b.start);
  let mergedSubs=[];
  subs.forEach(s=>{
    if(mergedSubs.length===0) {
      mergedSubs.push(s);
      return;
    }
    let last = mergedSubs[mergedSubs.length-1];
    let lastEnd = new Date(last.start.getTime() + 7*24*3600*1000);
    if(s.start <= lastEnd){
      // Extend previous subscription
      mergedSubs.push({...s, extended:true});
    } else {
      mergedSubs.push(s);
    }
  });

 // Process claims
 let claims=[];
 for(let i=0;i<b2.length;i+=3){
   let ts=b2[i+2]?.trim();
   let tier=b2[i+1]?.trim();
   if(!ts || !tier) continue;
   claims.push({tier, ts: parseTS(ts)});
 }
  // Valid subscriptions table
  let validHTML = '<table><tr><th>Tier</th><th>Amount</th><th>Purchase Date</th></tr>';
  mergedSubs.forEach(s=>{
    validHTML += `<tr class="${s.extended?'extended':''}"><td>${s.tier}</td><td>${s.amt}</td><td>${s.originalStart.toLocaleString('en-GB', {hour12:false})}</td></tr>`;
  });
  validHTML += '</table>';
  document.getElementById('validSubs').innerHTML = validHTML;

 // Generate subscription grid
 let html='';
 subs.forEach((s,idx)=>{
   const color = s.tier==='Bronze'?'bronze':s.tier==='Silver'?'silver':'gold';
   html += `<h3 class="${color}">${s.tier} Subscription (${s.start.toISOString().slice(0,19).replace('T',' ')} â†’ TBD)</h3>`;
   let days=[];
   for(let d=0; d<7; d++){
     let dayStart = new Date(s.start.getTime() + d*86400000);
     let dayEnd = new Date(dayStart.getTime() + 86400000);
     let claim = claims.find(c=>c.tier===s.tier && c.ts>=dayStart && c.ts<dayEnd);
     let today = new Date();
     let cls = claim? 'claimed': (dayEnd>today? 'future':'missed');
     days.push(`<div class="day ${cls}"><b>Day ${d+1}</b><br>${dayStart.toISOString().slice(0,19).replace('T',' ')}${claim? '<br>Claimed':''}${cls==='future'?'<br>Future':''}${cls==='missed'?'<br>Not Claimed':''}</div>`);
   }
   html += `<div class="grid">${days.join('')}</div>`;
 });
 document.getElementById('results').innerHTML = html;
  // Read Game Flow Data
  let claims=[];
  for(let i=0;i<b2.length;i+=3){
    let line1 = b2[i].split(/\t+/);
    let line3 = b2[i+2]?.trim();
    let gc = parseFloat(line1[2]);
    let unplayed = parseFloat(line1[1]);
    let tier = null;
    if(unplayed===0.5 && gc===2000) tier='Bronze';
    if(unplayed===2 && gc===10000) tier='Silver';
    if(unplayed===5.5 && gc===40000) tier='Gold';
    if(!tier) continue;
    claims.push({tier, ts:adjustDateForReset(parseTS(line3))});
  }

  // Render analyzed subscription grid
  let html='';
  mergedSubs.forEach((s,idx)=>{
    const color = s.tier==='Bronze'?'bronze':s.tier==='Silver'?'silver':'gold';
    html += `<h3 class="${color}">${s.tier} Subscription (${s.originalStart.toLocaleString('en-GB', {hour12:false})}${s.extended?' - Extended':''})</h3>`;
    let days=[];
    for(let d=0; d<7; d++){
      let dayStart = new Date(s.start.getTime());
      if(d===0) dayStart = s.start;
      else dayStart.setDate(s.start.getDate() + d);
      dayStart.setHours(8,0,0,0);
      let dayEnd = new Date(dayStart.getTime() + 24*3600*1000);
      let claim = claims.find(c=>c.tier===s.tier && c.ts>=dayStart && c.ts<dayEnd);
      let today = new Date();
      let cls = claim? 'claimed': (dayEnd>today? 'future':'missed');
      days.push(`<div class="day ${cls}"><b>Day ${d+1}</b><br>${dayStart.toLocaleDateString()} ${String(dayStart.getHours()).padStart(2,'0')}:${String(dayStart.getMinutes()).padStart(2,'0')}<br>${claim? 'Claimed':''}${cls==='future'?'<br>Future':''}${cls==='missed'?'<br>Not Claimed':''}</div>`);
    }
    html += `<div class="grid">${days.join('')}</div>`;
  });
  document.getElementById('results').innerHTML = html;
}
</script>

<p style="margin-top:40px; font-size:12px;">Signature by: Paul P</p>
</body>
</html>
