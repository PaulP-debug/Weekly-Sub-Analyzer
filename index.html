<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Weekly Subscription Analyzer</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
    font-family: Arial, sans-serif;
    background: #f3f3f3;
    padding: 20px;
}

h1 {
    text-align: center;
    margin-bottom: 20px;
}

.container {
    max-width: 1200px;
    margin: auto;
}

textarea {
    width: 100%;
    height: 200px;
    padding: 10px;
    font-size: 14px;
}

button {
    margin-top: 10px;
    padding: 12px 20px;
    font-size: 16px;
    background: #4CAF50;
    color: white;
    border: none;
    cursor: pointer;
    border-radius: 6px;
}
button:hover { background: #45a049; }

.result-box {
    background: white;
    padding: 20px;
    margin-top: 20px;
    border-radius: 8px;
}

/* Calendar color boxes */
.day-box {
    display: inline-block;
    width: 80px;
    height: 40px;
    text-align: center;
    line-height: 40px;
    margin: 5px;
    border-radius: 6px;
    color: white;
    font-weight: bold;
}

.claimed   { background: #4CAF50; }
.notclaimed { background: #E53935; }
.toclaim   { background: #FBC02D; }

/* Expandable panel */
.details {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.4s ease-out;
}

.details.open {
    max-height: 2000px;
    transition: max-height 0.5s ease-in;
}

.toggle-btn {
    background: #2196F3;
    margin-top: 10px;
}
.toggle-btn:hover {
    background: #1976D2;
}

/* Header color */
.sub-header {
    padding: 10px;
    color: white;
    border-radius: 6px;
    margin-bottom: 10px;
}

.bronze { background: #cd7f32; }
.silver { background: #C0C0C0; color: black; }
.gold   { background: #FFD700; color: black; }

</style>
</head>
<body>

<div class="container">
    <h1>Weekly Subscription Analyzer</h1>

    <h3>Box 1 (Subscriptions Data)</h3>
    <textarea id="box1" placeholder="Paste Box 1 data here..."></textarea>

    <h3>Box 2 (Claiming Data)</h3>
    <textarea id="box2" placeholder="Paste Box 2 data here..."></textarea>

    <button onclick="analyze()">Analyze</button>

    <div id="results"></div>
</div>

<script>
function analyze() {
    const box1 = document.getElementById("box1").value.trim().split("\n");
    const box2 = document.getElementById("box2").value.trim().split("\n");
    let resultsHTML = "";

    const subscriptions = [];

    // Process BOX 1
    for (let i = 1; i < box1.length; i++) {
        const cols = box1[i].split("\t");

        const status = cols[0];
        const updated = cols[1];
        const purchaseType = cols[6];
        const amount = parseFloat(cols[7]);

        if (purchaseType !== "sub_pack") continue;
        if (status !== "Succeed") continue;

        let type = "";
        if (amount === 7) type = "Bronze";
        else if (amount === 30) type = "Silver";
        else if (amount === 90) type = "Gold";
        else continue;

        const start = new Date(updated);
        const end = new Date(start);
        end.setDate(start.getDate() + 7);
        end.setHours(8,0,0,0);

        subscriptions.push({
            type,
            start,
            end,
            claims: []
        });
    }

    // Process BOX 2 – claim matching
    for (let i = 1; i < box2.length; i++) {
        const cols = box2[i].split("\t");

        const unplayed = parseFloat(cols[1]);
        const gc = parseFloat(cols[2]);
        const created = new Date(cols[9]);

        let claimType = "";
        if (unplayed === 0.5 && gc === 2000) claimType = "Bronze";
        if (unplayed === 2 && gc === 10000) claimType = "Silver";
        if (unplayed === 5.5 && gc === 40000) claimType = "Gold";

        subscriptions.forEach(sub => {
            if (sub.type === claimType && created >= sub.start && created <= sub.end) {
                sub.claims.push(created);
            }
        });
    }

    // Build Results
    subscriptions.forEach((sub, index) => {
        const colorClass = sub.type.toLowerCase();

        resultsHTML += `
        <div class="result-box">
            <div class="sub-header ${colorClass}">
                <h2>${sub.type} Subscription #${index + 1}</h2>
                <p>${sub.start.toLocaleString()} → ${sub.end.toLocaleString()}</p>
            </div>
            <h3>7-Day Calendar</h3>
        `;

        // Calendar Display
        for (let d = 0; d < 7; d++) {
            const day = new Date(sub.start);
            day.setDate(sub.start.getDate() + d);

            const today = new Date();
            let css = "notclaimed";
            let label = "Not Claimed";

            const claimedToday = sub.claims.filter(t =>
                t.getFullYear() === day.getFullYear() &&
                t.getMonth() === day.getMonth() &&
                t.getDate() === day.getDate()
            );

            if (claimedToday.length > 0) {
                css = "claimed";
                label = "Claimed";
            } else if (day > today) {
                css = "toclaim";
                label = "To Be Claimed";
            }

            resultsHTML += `
                <div class="day-box ${css}">
                    Day ${d + 1}<br>${label}
                </div>
            `;
        }

        // Details section
        const detailsId = "details_" + index;

        resultsHTML += `
            <button class="toggle-btn" onclick="toggleDetails('${detailsId}')">Show Details ▼</button>
            <div id="${detailsId}" class="details">
        `;

        for (let d = 0; d < 7; d++) {
            const day = new Date(sub.start);
            day.setDate(sub.start.getDate() + d);

            const claimedToday = sub.claims.filter(t =>
                t.getFullYear() === day.getFullYear() &&
                t.getMonth() === day.getMonth() &&
                t.getDate() === day.getDate()
            );

            resultsHTML += `<p><strong>Day ${d + 1} — ${day.toDateString()}</strong><br>`;

            if (claimedToday.length === 0) {
                resultsHTML += "• No claim<br>";
            } else {
                claimedToday.forEach(t => {
                    resultsHTML += `• ${t.toLocaleString()}<br>`;
                });
            }

            resultsHTML += "</p>";
        }

        resultsHTML += `</div></div>`;
    });

    document.getElementById("results").innerHTML = resultsHTML;
}

function toggleDetails(id) {
    const el = document.getElementById(id);
    el.classList.toggle("open");
}
</script>

</body>
</html>
